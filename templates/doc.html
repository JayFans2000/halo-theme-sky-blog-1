<!-- Docsme 文档内容页面 - 完全自定义 -->
<!doctype html>
<html
  xmlns:th="https://www.thymeleaf.org"
  th:replace="~{modules/doc-layout :: html(head = ~{::head}, content = ~{::content}, scripts = ~{::scripts}, dock = ~{::dock})}"
>
  <th:block th:fragment="head">
    <!-- 代码高亮样式 -->
    <th:block th:replace="~{plugin:plugin-docsme:modules/prism}" />
  </th:block>
  <th:block th:fragment="content">
    <th:block th:replace="~{modules/doc-content :: content}" />
  </th:block>
  <!-- 文档页专用 Dock 和抽屉 -->
  <th:block th:fragment="dock">
    <th:block th:replace="~{modules/doc/floating-dock :: doc-dock}" />
    <th:block th:replace="~{modules/doc/floating-dock :: doc-comment-drawer}" />
    <th:block th:replace="~{modules/doc/floating-dock :: doc-toc-drawer}" />
    <th:block th:replace="~{modules/doc/floating-dock :: doc-sidebar-drawer}" />
  </th:block>
  <th:block th:fragment="scripts">
    <!-- 禁用插件的主题切换功能，使用主题自带的 -->
    <script>
      var docsme = { disableThemeFunction: true };
    </script>
    <!-- 其他插件脚本（搜索、绘图、KaTeX） -->
    <th:block th:replace="~{plugin:plugin-docsme:modules/plugin-scripts}" />
    <!-- 文档页目录生成脚本 - 复用文章页逻辑 -->
    <script>
      (function() {
        'use strict';
        
        function initDocTOC() {
          const tocNav = document.getElementById('toc-nav');
          const tocCard = document.getElementById('toc-card');
          const articleContent = document.getElementById('article-content');
          
          if (!tocNav || !articleContent) return;
          
          const headings = articleContent.querySelectorAll('h1, h2, h3, h4, h5, h6');
          if (headings.length === 0) {
            if (tocCard) tocCard.style.display = 'none';
            return;
          }
          
          // 动态识别层级
          const levels = Array.from(headings).map(h => parseInt(h.tagName.charAt(1)));
          const minLevel = Math.min(...levels);
          const maxDisplayLevel = minLevel + 2;
          
          const filteredHeadings = Array.from(headings).filter(h => {
            return parseInt(h.tagName.charAt(1)) <= maxDisplayLevel;
          });
          
          if (filteredHeadings.length === 0) {
            if (tocCard) tocCard.style.display = 'none';
            return;
          }
          
          // 生成目录
          const ol = document.createElement('ol');
          ol.className = 'toc-list';
          
          filteredHeadings.forEach((heading, index) => {
            if (!heading.id) heading.id = 'heading-' + index;
            
            const level = parseInt(heading.tagName.charAt(1));
            const relativeLevel = level - minLevel;
            
            const li = document.createElement('li');
            li.className = 'toc-item-wrapper';
            li.style.setProperty('--toc-indent-multiplier', relativeLevel.toString());
            
            const link = document.createElement('a');
            link.href = '#' + heading.id;
            link.textContent = heading.textContent.trim();
            link.className = 'toc-link';
            link.setAttribute('data-relative-level', relativeLevel.toString());
            link.setAttribute('data-heading-id', heading.id);
            
            link.addEventListener('click', function(e) {
              e.preventDefault();
              const target = document.getElementById(heading.id);
              if (target) {
                const navbarHeight = 80;
                window.scrollTo({
                  top: target.offsetTop - navbarHeight,
                  behavior: 'smooth'
                });
              }
            });
            
            li.appendChild(link);
            ol.appendChild(li);
          });
          
          tocNav.innerHTML = '';
          tocNav.appendChild(ol);
          
          // 滚动高亮
          let isUpdating = false;
          const updateActive = () => {
            const scrollPos = window.scrollY + 120;
            let activeIndex = -1;
            
            filteredHeadings.forEach((h, i) => {
              if (h.offsetTop <= scrollPos) activeIndex = i;
            });
            
            document.querySelectorAll('.toc-link').forEach((link, i) => {
              link.classList.toggle('active', i === activeIndex);
            });
            isUpdating = false;
          };
          
          window.addEventListener('scroll', () => {
            if (!isUpdating) {
              requestAnimationFrame(updateActive);
              isUpdating = true;
            }
          }, { passive: true });
          
          updateActive();
        }
        
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', initDocTOC);
        } else {
          initDocTOC();
        }
      })();
    </script>
  </th:block>
</html>
