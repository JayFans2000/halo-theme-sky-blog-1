document.addEventListener("alpine:init",()=>{Alpine.data("postLike",()=>({isLiked:!1,likeCount:0,postName:"",init(){const t=this.$el.closest("[data-post-name]");t&&(this.postName=t.dataset.postName||"",this.likeCount=parseInt(t.dataset.upvoteCount||"0"),this.checkLikeStatus())},checkLikeStatus(){if(!this.postName)return;const t=JSON.parse(localStorage.getItem("halo.upvoted.post.names")||"[]");this.isLiked=t.includes(this.postName)},async toggleLike(){if(this.postName)if(this.isLiked)console.log("已经点赞过了");else try{console.log("发送点赞请求:",this.postName);const t=await fetch("/apis/api.halo.run/v1alpha1/trackers/upvote",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({group:"content.halo.run",plural:"posts",name:this.postName})});if(console.log("点赞响应状态:",t.status),t.ok){console.log("点赞成功"),this.isLiked=!0,this.likeCount+=1;const t=JSON.parse(localStorage.getItem("halo.upvoted.post.names")||"[]");t.includes(this.postName)||(t.push(this.postName),localStorage.setItem("halo.upvoted.post.names",JSON.stringify(t)))}else{const e=await t.text();console.error("点赞失败:",t.status,e)}}catch(t){console.error("点赞请求错误:",t)}else console.warn("文章名称未找到")}})),Alpine.data("postComment",()=>({commentCount:0,isOpen:!1,init(){const t=this.$el.closest("[data-comment-count]");t&&(this.commentCount=parseInt(t.dataset.commentCount||"0")),window.addEventListener("toggle-comment-drawer",()=>{const t=document.getElementById("comment-drawer");t&&(this.isOpen=t.checked)})}}))}),function(){const t={init(){this.initTOC(),this.initReadingProgress(),this.initCodeCopy(),this.initScrollToTop()},initTOC(){const t=document.getElementById("toc-nav");if(!t)return;const e=document.getElementById("article-content");if(!e)return;const o=e.querySelectorAll("h1, h2, h3, h4, h5, h6");if(0===o.length)return;const n=this.analyzeHeadingHierarchy(o);if(0===n.filteredHeadings.length)return;const i=this.buildDynamicTocTree(n.filteredHeadings,n.minLevel),s=this.createDynamicTocHTML(i);t.innerHTML="",t.appendChild(s),this.initTocScrollHighlight(n.filteredHeadings),this.initAdaptiveLayout()},analyzeHeadingHierarchy(t){const e=Array.from(t),o=e.map(t=>parseInt(t.tagName.charAt(1))),n=Math.min(...o),i=n+2;return{filteredHeadings:e.filter(t=>parseInt(t.tagName.charAt(1))<=i),minLevel:n,maxDisplayLevel:i,totalLevels:o.length>0?Math.max(...o)-n+1:0}},buildDynamicTocTree(t,e){const o=[],n=[];return t.forEach((t,i)=>{t.id||(t.id=`heading-${i}`);const s=parseInt(t.tagName.charAt(1)),a=s-e,l={id:t.id,text:t.textContent.trim(),absoluteLevel:s,relativeLevel:a,element:t,children:[]};for(;n.length>0&&n[n.length-1].relativeLevel>=a;)n.pop();0===n.length?o.push(l):n[n.length-1].children.push(l),n.push(l)}),o},createDynamicTocHTML(t){const e=document.createElement("ol");return e.className="toc-list",t.forEach(t=>{const o=document.createElement("li");o.className="toc-item-wrapper";const n=t.relativeLevel;o.style.setProperty("--toc-indent-multiplier",n.toString());const i=document.createElement("a");if(i.href=`#${t.id}`,i.textContent=t.text,i.className="toc-link tooltip tooltip-right",i.setAttribute("data-relative-level",t.relativeLevel.toString()),i.setAttribute("data-absolute-level",t.absoluteLevel.toString()),i.setAttribute("data-heading-id",t.id),i.setAttribute("data-tip",t.text),i.addEventListener("click",e=>{e.preventDefault(),this.smoothScrollToHeading(t.element)}),o.appendChild(i),t.children.length>0){const e=this.createDynamicTocHTML(t.children);o.appendChild(e)}e.appendChild(o)}),e},initAdaptiveLayout(){if(document.querySelector(".toc-container")){if(window.ResizeObserver){new ResizeObserver(()=>{this.updateTocLayout()}).observe(document.documentElement)}window.addEventListener("resize",()=>{clearTimeout(this.resizeTimeout),this.resizeTimeout=setTimeout(()=>{this.updateTocLayout()},150)}),this.updateTocLayout()}},updateTocLayout(){const t=document.querySelector(".toc-container");if(!t)return;const e=document.getElementById("toc-nav");if(!e)return;const o=e.scrollHeight,n=window.innerHeight-120-32-60-40,i=Math.max(n,200),s=Math.min(o+20,i);t.style.maxHeight=`${s}px`;const a=o>s;t.classList.toggle("has-scroll",a)},smoothScrollToHeading(t){if(!t)return;const e=t.offsetTop-80;window.scrollTo({top:e,behavior:"smooth"})},getMinHeadingLevel(t){let e=6;return t.forEach(t=>{const o=parseInt(t.tagName.charAt(1));o<e&&(e=o)}),e},initTocScrollHighlight(t){let e=!1;const o=()=>{const o=window.scrollY+120,n=window.innerHeight,i=document.documentElement.scrollHeight;let s=-1;o+n>=i-50?s=t.length-1:t.forEach((e,n)=>{const a=e.offsetTop,l=t[n+1],c=l?l.offsetTop:i;a<=o&&o<c&&(s=n)}),this.updateTocHighlight(s),e=!1};window.addEventListener("scroll",()=>{e||(requestAnimationFrame(o),e=!0)},{passive:!0}),o()},updateTocHighlight(t){document.querySelectorAll(".toc-link").forEach((e,o)=>{if(o===t){e.classList.add("active");const t=document.querySelector(".toc-container");t&&this.scrollToActiveItem(t,e)}else e.classList.remove("active")})},scrollToActiveItem(t,e){const o=t.scrollTop,n=t.clientHeight,i=t.scrollHeight;let s=0,a=e;for(;a&&a!==t&&(s+=a.offsetTop,a=a.offsetParent,a!==t););if(a!==t){const o=t.getBoundingClientRect().top+window.scrollY;s=e.getBoundingClientRect().top+window.scrollY-o+t.scrollTop}const l=e.offsetHeight,c=o,r=o+n,d=s,h=s+l,m=d>=c&&h<=r,u=d<r&&h>c;if(!m){let e;const o=Math.max(0,i-n),a=0,p=n/2-l/2;if(e=s-p,e<a)e=s<n/3?a:Math.max(a,s-40);else if(e>o){e=i-s-l<n/3?o:Math.min(o,s-n+l+40)}if(h<c){e=c-h>n?Math.max(a,s-p):Math.max(a,s-20)}else if(d>r){e=d-r>n?Math.min(o,s-p):Math.min(o,s-n+l+20)}const g=t.scrollTop,v=Math.abs(e-g);if(v>5){const l=v>n?"auto":"smooth";t.scrollTo({top:e,behavior:l}),"localhost"===window.location.hostname&&console.log("TOC Scroll Debug:",{itemOffsetTop:s,containerHeight:n,containerScrollHeight:i,targetScrollTop:e,currentScrollTop:g,scrollDifference:v,scrollBehavior:l,isFullyVisible:m,isPartiallyVisible:u,maxScrollTop:o,minScrollTop:a})}}},initReadingProgress(){const t=document.getElementById("reading-progress");if(!t)return;let e=!1;const o=()=>{const o=document.documentElement.scrollHeight-window.innerHeight,n=window.scrollY/o*100;t.style.width=`${Math.min(n,100)}%`,e=!1};window.addEventListener("scroll",()=>{e||(requestAnimationFrame(o),e=!0)},{passive:!0})},initCodeCopy(){document.querySelectorAll("pre code").forEach(t=>{const e=t.parentElement;if(!e)return;const o=document.createElement("button");o.className="absolute top-2 right-2 px-3 py-1 bg-base-200 hover:bg-base-300 rounded text-sm transition-colors",o.textContent="复制",o.setAttribute("aria-label","复制代码"),e.style.position="relative",e.appendChild(o),o.addEventListener("click",async()=>{try{await navigator.clipboard.writeText(t.textContent),o.textContent="已复制",o.classList.add("bg-success","text-success-content"),setTimeout(()=>{o.textContent="复制",o.classList.remove("bg-success","text-success-content")},2e3)}catch(e){console.error("复制失败:",e),o.textContent="复制失败",setTimeout(()=>{o.textContent="复制"},2e3)}})})},initScrollToTop(){const t=document.getElementById("scroll-to-top");if(!t)return;let e=!1;const o=()=>{window.scrollY>300?(t.classList.remove("opacity-0","pointer-events-none"),t.classList.add("opacity-100")):(t.classList.add("opacity-0","pointer-events-none"),t.classList.remove("opacity-100")),e=!1};window.addEventListener("scroll",()=>{e||(requestAnimationFrame(o),e=!0)},{passive:!0}),t.addEventListener("click",()=>{"scrollBehavior"in document.documentElement.style?window.scrollTo({top:0,behavior:"smooth"}):window.scrollTo(0,0)})}};document.addEventListener("DOMContentLoaded",()=>{t.init()})}();
