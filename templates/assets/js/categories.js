document.addEventListener("alpine:init",()=>{Alpine.data("categoriesPage",()=>({activeSlug:"all",activeName:"全部",isLoading:!1,isSwitching:!1,items:[],nextUrl:"",observer:null,init(){const t=document.getElementById("initial-next-url");this.nextUrl=t?.value||"";const e=Array.from(document.querySelectorAll("#category-posts article"));this.items=e.map(r=>{const i=r.querySelector("h3"),s=r.querySelector("a");return r.querySelector("span"),{spec:{title:i?.textContent?.trim()||""},status:{permalink:s?.getAttribute("href")||"#"},stats:{},metadata:{name:s?.getAttribute("href")||""}}});const n=new CustomEvent("category-items",{detail:this.items});document.dispatchEvent(n),this.enableInfiniteScroll()},enableInfiniteScroll(){const t=document.getElementById("infinite-sentinel");t&&(this.observer=new IntersectionObserver(e=>{e.forEach(n=>{n.isIntersecting&&this.loadMore()})},{root:null,rootMargin:"0px 0px 200px 0px",threshold:0}),this.observer.observe(t))},async switchCategory(t){if(this.activeSlug===t&&!this.isSwitching)return;this.isSwitching=!0,this.isLoading=!0,this.activeSlug=t,this.activeName=t==="all"?"全部":this.findNameBySlug(t);const e=t==="all"?"/categories":`/categories/${encodeURIComponent(t)}`;try{const n=performance.now(),r=await this.fetchPage(e),{listHtml:i,nextUrl:s}=this.extractList(r);this.renderList(i),this.nextUrl=s||"",performance.now()-n<300}catch(n){console.warn("切换分类失败：",n)}finally{this.isLoading=!1,setTimeout(()=>{this.isSwitching=!1},200)}},async loadMore(){if(!(!this.nextUrl||this.isLoading)){this.isLoading=!0;try{const t=await this.fetchPage(this.nextUrl),{itemsHtml:e,nextUrl:n}=this.extractItems(t);this.appendItems(e),this.nextUrl=n||""}catch(t){console.warn("加载更多失败：",t)}finally{this.isLoading=!1}}},findNameBySlug(t){return document.querySelector(`button[data-slug="${CSS.escape(t)}"] span.font-medium`)?.textContent?.trim()||t},async fetchPage(t){return await(await fetch(t,{headers:{"X-Requested-With":"fetch"}})).text()},extractList(t){const e=new DOMParser().parseFromString(t,"text/html"),n=e.querySelector("#category-posts"),r=e.querySelector("#initial-next-url");return{listHtml:n?.innerHTML||"",nextUrl:r?.getAttribute("value")||""}},extractItems(t){const e=new DOMParser().parseFromString(t,"text/html"),n=e.querySelector("#category-posts"),r=e.querySelector("#initial-next-url");return{itemsHtml:n?Array.from(n.children).map(s=>s.outerHTML).join(""):"",nextUrl:r?.getAttribute("value")||""}},renderList(t){const e=document.getElementById("category-posts");if(!e)return;e.innerHTML=t||"";const n=Array.from(e.querySelectorAll("article"));this.items=n.map(i=>{const s=i.querySelector("h3"),a=i.querySelector("a");return{spec:{title:s?.textContent?.trim()||""},status:{permalink:a?.getAttribute("href")||"#"},stats:{},metadata:{name:a?.getAttribute("href")||""}}});const r=new CustomEvent("category-items",{detail:this.items});document.dispatchEvent(r)},appendItems(t){const e=document.getElementById("category-posts");if(!e||!t)return;const n=document.createRange().createContextualFragment(t);e.appendChild(n)}})),Alpine.data("categoryArchive",()=>({nextUrl:"",isLoading:!1,observer:null,init(){const t=document.getElementById("initial-next-url");this.nextUrl=t?.value||"",this.enableInfiniteScroll();const n=Array.from(document.querySelectorAll("#category-posts article")).map(i=>{const s=i.querySelector("h3"),a=i.querySelector("a");return i.querySelector("span"),{spec:{title:s?.textContent?.trim()||""},status:{permalink:a?.getAttribute("href")||"#"},stats:{},metadata:{name:a?.getAttribute("href")||""}}}),r=new CustomEvent("category-items",{detail:n});document.dispatchEvent(r)},enableInfiniteScroll(){const t=document.getElementById("infinite-sentinel");t&&(this.observer=new IntersectionObserver(e=>{e.forEach(n=>{n.isIntersecting&&this.loadMore()})},{root:null,rootMargin:"0px 0px 200px 0px",threshold:0}),this.observer.observe(t))},async loadMore(){if(!(!this.nextUrl||this.isLoading)){this.isLoading=!0;try{const e=await(await fetch(this.nextUrl,{headers:{"X-Requested-With":"fetch"}})).text(),n=new DOMParser().parseFromString(e,"text/html"),r=n.querySelector("#category-posts"),i=n.querySelector("#initial-next-url"),s=r?Array.from(r.children).map(o=>o.outerHTML).join(""):"",a=document.getElementById("category-posts");a&&s&&a.appendChild(document.createRange().createContextualFragment(s)),this.nextUrl=i?.getAttribute("value")||""}catch(t){console.warn("归档页加载更多失败：",t)}finally{this.isLoading=!1}}}}))});
