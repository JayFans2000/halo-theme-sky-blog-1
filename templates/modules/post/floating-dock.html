<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org">

<!-- ========================================== -->
<!--          文章页悬浮 Dock 控制栏             -->
<!-- ========================================== -->

<!-- 文章页悬浮 Dock 入口片段 - 根据样式选择 -->
<th:block th:fragment="dock" th:if="${theme.config.general.floating_dock?.enable_dock != false}" th:with="cfg = ${theme.config.article.dock_settings},
                   enableCustom = ${cfg?.enable_custom_dock},
                   pageDockStyle = ${cfg?.dock_style ?: 'bottom'},
                   globalDockStyle = ${theme.config.general.floating_dock?.dock_style ?: 'bottom'},
                   dockStyle = ${enableCustom ? pageDockStyle : globalDockStyle}">
  <!-- 底部居中样式 -->
  <th:block th:if="${dockStyle != 'side'}" th:insert="~{:: bottomDock}" />
  <!-- 右侧可折叠样式 -->
  <th:block th:if="${dockStyle == 'side'}" th:insert="~{:: sideDock}" />
</th:block>

<!-- ========================================== -->
<!--          底部居中样式                        -->
<!-- ========================================== -->

<th:block th:fragment="bottomDock">
  <div x-data="floatingDock" @toggle-comment-drawer.window="toggleCommentDrawer()"
    th:attr="data-post-name=${post.metadata.name},data-upvote-count=${post.stats.upvote ?: 0},data-comment-count=${post.stats.comment ?: 0}"
    x-show="isVisible" x-transition:enter="transition ease-in-out duration-400"
    x-transition:enter-start="opacity-0 translate-y-8" x-transition:enter-end="opacity-100 translate-y-0"
    x-transition:leave="transition ease-in-out duration-300" x-transition:leave-start="opacity-100 translate-y-0"
    x-transition:leave-end="opacity-0 translate-y-4" class="fixed bottom-6 left-1/2 -translate-x-1/2 z-50">

    <!-- Dock 容器 -->
    <div class="dock-container bg-base-100/90 backdrop-blur-md shadow-lg rounded-full border border-base-300/30 px-2 py-1.5">

        <!-- Dock 按钮组 -->
        <div class="flex items-center gap-1">

          <!-- 自定义菜单图标 -->
          <th:block th:with="cfg = ${theme.config.article.dock_settings},
                     enableCustom = ${cfg?.enable_custom_dock},
                     globalDock = ${theme.config.general.floating_dock},
                     menuName = ${enableCustom ? (cfg?.post_dock_menu ?: 'primary') : (globalDock?.dock_menu ?: 'primary')},
                     dockMenu = ${menuFinder.getByName(menuName)}">
            <th:block th:if="${dockMenu != null}">
              <a th:each="menuItem : ${dockMenu.menuItems}" th:href="@{${menuItem.status.href}}"
                th:target="${menuItem.spec.target?.value}" class="dock-item dock-btn group relative"
                th:title="${menuItem.status.displayName}">
                <!-- 使用菜单的自定义元数据 icon 字段（SVG 代码） -->
                <div th:if="${menuItem.metadata?.annotations != null && menuItem.metadata.annotations['icon'] != null}"
                  class="w-4 h-4 transition-transform duration-200 group-hover:scale-110 flex items-center justify-center">
                  <div th:utext="${menuItem.metadata.annotations['icon']}" class="dock-icon-svg"></div>
                </div>
                <!-- 备用图标（如果没有自定义 icon） -->
                <span
                  th:unless="${menuItem.metadata?.annotations != null && menuItem.metadata.annotations['icon'] != null}"
                  class="icon-[heroicons--home] w-4 h-4 transition-transform duration-200 group-hover:scale-110">
                </span>
                <span
                  class="dock-tooltip absolute -top-10 left-1/2 -translate-x-1/2 px-2 py-1 bg-base-content text-base-100 text-xs rounded opacity-0 group-hover:opacity-100 transition-opacity duration-200 whitespace-nowrap pointer-events-none"
                  th:text="${menuItem.status.displayName}">
                </span>
              </a>
            </th:block>
          </th:block>

          <!-- 分隔线（目录按钮前） - 跟随目录按钮显示逻辑 -->
          <div th:if="${theme.config.article.dock_settings?.enable_toc_drawer}"
            th:classappend="${theme.config.article.sidebar_settings?.show_sidebar == true} ? 'lg:hidden!' : ''"
            class="w-px h-6 bg-base-300/50"></div>

          <!-- 目录按钮 - 仅移动端或隐藏侧边栏时显示 -->
          <button th:if="${theme.config.article.dock_settings?.enable_toc_drawer}"
            th:classappend="${theme.config.article.sidebar_settings?.show_sidebar == true} ? 'lg:hidden!' : ''"
            onclick="window.openPostTocDrawer()" class="dock-item dock-btn group relative" title="目录">
            <span class="icon-[heroicons--list-bullet] w-4 h-4 transition-transform duration-200 group-hover:scale-110">
            </span>
            <!-- 目录 Tooltip -->
            <span
              class="dock-tooltip absolute -top-10 left-1/2 -translate-x-1/2 px-2 py-1 bg-base-content text-base-100 text-xs rounded opacity-0 group-hover:opacity-100 transition-opacity duration-200 whitespace-nowrap pointer-events-none">
              文章目录
            </span>
          </button>

          <!-- 分隔线（返回顶部前） - 仅当返回顶部启用时显示 -->
          <div class="w-px h-6 bg-base-300/50" th:if="${theme.config.article.dock_settings?.enable_back_to_top}"></div>

          <!-- 返回顶部按钮 -->
          <button th:if="${theme.config.article.dock_settings.enable_back_to_top}" @click="scrollToTop()"
            class="dock-item dock-btn" title="返回顶部">
            <span class="icon-[heroicons--arrow-up] w-4 h-4"></span>
          </button>

        </div>
      </div>

  </div>
</th:block>

<!-- ========================================== -->
<!--          右侧可折叠样式 (FAB)                -->
<!-- ========================================== -->

<th:block th:fragment="sideDock">
  <div x-data="sideFloatingDock"
    th:attr="data-post-name=${post.metadata.name},data-upvote-count=${post.stats.upvote ?: 0},data-comment-count=${post.stats.comment ?: 0}"
    x-show="isVisible" class="fixed right-4 bottom-6 z-40">

    <!-- DaisyUI FAB 组件 -->
    <div class="fab fab-top">
      <!-- 触发按钮 -->
      <div tabindex="0" role="button" class="btn btn-circle btn-primary shadow-lg">
        <span class="icon-[heroicons--squares-2x2] w-5 h-5"></span>
      </div>

      <!-- 关闭按钮（展开时显示） -->
      <div class="fab-close">
        <span class="text-sm whitespace-nowrap text-base-content/70 hidden sm:block">关闭</span>
        <span class="btn btn-circle btn-neutral shadow-lg">
          <span class="icon-[heroicons--x-mark] w-5 h-5"></span>
        </span>
      </div>

      <!-- 自定义菜单项 -->
      <th:block th:with="cfg = ${theme.config.article.dock_settings},
                 enableCustom = ${cfg?.enable_custom_dock},
                 globalDock = ${theme.config.general.floating_dock},
                 menuName = ${enableCustom ? (cfg?.post_dock_menu ?: 'primary') : (globalDock?.dock_menu ?: 'primary')},
                 dockMenu = ${menuFinder.getByName(menuName)}">
        <th:block th:if="${dockMenu != null}">
          <div th:each="menuItem : ${dockMenu.menuItems}">
            <span class="text-sm whitespace-nowrap hidden sm:block" th:text="${menuItem.status.displayName}">菜单</span>
            <a th:href="@{${menuItem.status.href}}" th:target="${menuItem.spec.target?.value}" class="btn btn-circle"
              th:title="${menuItem.status.displayName}">
              <div th:if="${menuItem.metadata?.annotations != null && menuItem.metadata.annotations['icon'] != null}"
                class="w-5 h-5 flex items-center justify-center">
                <div th:utext="${menuItem.metadata.annotations['icon']}" class="dock-icon-svg"></div>
              </div>
              <span
                th:unless="${menuItem.metadata?.annotations != null && menuItem.metadata.annotations['icon'] != null}"
                class="icon-[heroicons--home] w-5 h-5"></span>
            </a>
          </div>
        </th:block>
      </th:block>

      <!-- 目录按钮 - 仅移动端或隐藏侧边栏时显示 -->
      <div th:if="${theme.config.article.dock_settings?.enable_toc_drawer}"
        th:classappend="${theme.config.article.sidebar_settings?.show_sidebar == true} ? 'lg:hidden!' : ''">
        <span class="text-sm whitespace-nowrap hidden sm:block">目录</span>
        <button class="btn btn-circle" onclick="window.openPostTocDrawer()">
          <span class="icon-[heroicons--list-bullet] w-5 h-5"></span>
        </button>
      </div>

      <!-- 返回顶部按钮 -->
      <div th:if="${theme.config.article.dock_settings.enable_back_to_top}">
        <span class="text-sm whitespace-nowrap hidden sm:block">返回顶部</span>
        <button class="btn btn-circle" @click="scrollToTop()">
          <span class="icon-[heroicons--arrow-up] w-5 h-5"></span>
        </button>
      </div>
    </div>

  </div>
</th:block>

<!-- ========================================== -->
<!--              分享弹窗                       -->
<!-- ========================================== -->

<!-- 分享弹窗 - 使用通用组件 -->
<th:block th:fragment="shareModal" th:if="${theme.config.article.post_interaction.enable_share}">
  <th:block th:replace="~{modules/share-modal :: shareModal(
    title='分享文章',
    shareUrl=${post.status.permalink},
    shareTitle=${post.spec.title},
    shareItemIds=${theme.config.article.post_interaction.share_settings.share_item_ids}
  )}" />
</th:block>

<!-- ========================================== -->
<!--              目录抽屉                       -->
<!-- ========================================== -->

<!-- 目录抽屉 - 原生实现，不依赖 Alpine 组件 -->
<th:block th:fragment="tocDrawer" th:if="${theme.config.article.dock_settings.enable_toc_drawer}">
  <!-- 遮罩层 -->
  <div id="post-toc-overlay" class="post-toc-overlay" onclick="window.closePostTocDrawer()"></div>
  <!-- 抽屉面板 -->
  <div id="post-toc-drawer" class="post-toc-drawer">
    <!-- 标题栏 -->
    <div class="flex items-center justify-between px-5 py-4 border-b border-base-200">
      <h3 class="text-base font-semibold flex items-center gap-2">
        <span class="icon-[heroicons--list-bullet] w-5 h-5 text-primary"></span>
        <span>文章目录</span>
      </h3>
      <button onclick="window.closePostTocDrawer()" class="btn btn-ghost btn-circle btn-sm">
        <span class="icon-[heroicons--x-mark] w-5 h-5"></span>
      </button>
    </div>
    <!-- 目录内容 -->
    <div class="flex-1 overflow-y-auto p-5 scrollbar-thin">
      <nav id="post-toc-drawer-nav" class="space-y-1" role="navigation" aria-label="文章目录">
        <!-- 目录由 JS 生成 -->
      </nav>
    </div>
  </div>
</th:block>

</html>